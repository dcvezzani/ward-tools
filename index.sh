lines=$(cat cookie.txt | perl -p -e 's# #\n#g' | grep 'ObSSOCookie\|directory_access_token\|directory_refresh_token')
authorization_bearer=$(cat cookie.txt | perl -p -e 's#^.*authorization: Bearer ([^'"'"']*).*#\1#g')
ObSSOCookie=$(echo $lines | perl -p -e 's#^.*ObSSOCookie=([^ ;]*).*#\1#g' | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
directory_access_token=$(echo $lines | perl -p -e 's#^.*directory_access_token=([^ ;]*).*#\1#g' | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
directory_refresh_token=$(echo $lines | perl -p -e 's#^.*directory_refresh_token=([^ ;]*).*#\1#g' | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')

# ObSSOCookie=$(echo $lines | grep ObSSOCookie | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
# directory_access_token=$(echo $lines | grep directory_access_token | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
# directory_refresh_token=$(echo $lines | grep directory_refresh_token | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')

# echo $lines | perl -p -e 's# #\n#g'
# echo $ObSSOCookie

echo "fetching directory"

curl 'https://directory.churchofjesuschrist.org/api/v4/households?unit=13730' -H 'Pragma: no-cache' -H 'Accept-Encoding: gzip, deflate, br' -H 'x-refresh: 7ec81c2f-5f5b-42db-96e1-8eea3555c4c3' -H 'Accept-Language: en' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'Accept: */*' -H 'Cache-Control: no-cache' -H 'authorization: Bearer '"${authorization_bearer}" -H 'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; amlbcookie=74; ADRUM=s=1561094320300&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx5n8io4&sl=2&tt=3ws&bcn=%2F%2F17d98a5f.akstat.io%2F&ld=iio&nu=d8c25fb915b8ce73b552b78eb3a473dc&cl=jyu&ul=jz6&hd=kjp"; TS01289383=01999b7023068f27179da7e28c4900543f2fce1f371c7a7ec507d080f9faf989b1f2160ce83eceb477532db7c58ddaba84931cd79a; TS01b89640=01999b7023068f27179da7e28c4900543f2fce1f371c7a7ec507d080f9faf989b1f2160ce83eceb477532db7c58ddaba84931cd79a; lds-id=AQIC5wM2LY4SfcwNo0u0dq7NCq_AbcsbWJeudQEo6s_b3_Q.*AAJTSQACMDIAAlNLABMzNTA2MTI5OTk0MzExNDEzMTkxAAJTMQACMDQ.*; mboxEdgeCluster=28; ObSSOCookie='"${ObSSOCookie}"'; s_sq=%5B%5BB%5D%5D; TS0186bb65=01999b70232269ff637dbc011f79cd61b8dbf52d1b967ddcbfd7a1e3b97b257a454cf184a07cae282001bcfdade0854bbad865729d; directory_access_token='"${directory_access_token}"'; directory_refresh_token='"${directory_refresh_token}"'; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=-330454231%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561726626%7C9%7CMCAAMB-1561726626%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561129026s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C3.1.2; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_20#1624366628|session#ff3230f273da400499cd58b8c2185156#1561123662; t_ppv=Ward%20Directory%20and%20Map%2C0%2C100%2C460%2C4182; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:19$_ss:0$_st:1561123627260$vapi_domain:churchofjesuschrist.org$dc_visit:19$ses_id:1561119682911%3Bexp-session$_pn:6%3Bexp-session$dc_event:12%3Bexp-session$dc_region:us-east-1%3Bexp-session' -H 'Connection: keep-alive' -H 'Referer: https://directory.churchofjesuschrist.org/13730' --compressed > directory.json
sleep 2

cp directory.json directory-orig.json

cat directory-orig.json | jq 'def neighborhood: if (. | test( "Dry Creek"; "i" )) then "dry-creek" elif (. | test( "Quivira"; "i" )) then "quivira" elif (. | test( "Hackberry"; "i" )) then "hackberry" elif (. | test( "Samara"; "i" )) then "samara" elif (. | test( "Serrata"; "i" )) then "serrata" elif (. | test( "Silver Oak"; "i" )) then "silver-oak" elif (. | test( "Sterling"; "i" )) then "sterling-loop" elif (. | test( "Syracuse"; "i" )) then "syracuse" elif (. | test( "Drupe"; "i" )) then "drupe" elif (. | test( "Unity M"; "i" )) then "alloy-m" elif (. | test( "Unity N"; "i" )) then "alloy-n" elif (. | test( "Unity P"; "i" )) then "alloy-p" elif (. | test( "Unity Q"; "i" )) then "alloy-q" elif (. | test( "Unit M"; "i" )) then "alloy-m" elif (. | test( "Unit N"; "i" )) then "alloy-n" elif (. | test( "Unit P"; "i" )) then "alloy-p" elif (. | test( "Unit Q"; "i" )) then "alloy-q" elif (. | test( "Apt M"; "i" )) then "alloy-m" elif (. | test( "Apt N"; "i" )) then "alloy-n" elif (. | test( "Apt P"; "i" )) then "alloy-p" elif (. | test( "Apt Q"; "i" )) then "alloy-q" elif (. | test( "Unt M"; "i" )) then "alloy-m" elif (. | test( "Unt N"; "i" )) then "alloy-n" elif (. | test( "Unt P"; "i" )) then "alloy-p" elif (. | test( "Unt Q"; "i" )) then "alloy-q" else "n/a" end; map(. as $orig | (.address | neighborhood) as $district | $orig + {$district})' > directory.json

# cat directory.json | jq 'def neighborhood: if (. | test( "Dry Creek"; "i" )) then "dry-creek" elif (. | test( "Quivira"; "i" )) then "quivira" elif (. | test( "Hackberry"; "i" )) then "hackberry" elif (. | test( "Samara"; "i" )) then "samara" elif (. | test( "Serrata"; "i" )) then "serrata" elif (. | test( "Silver Oak"; "i" )) then "silver-oak" elif (. | test( "Sterling"; "i" )) then "sterling-loop" elif (. | test( "Syracuse"; "i" )) then "syracuse" elif (. | test( "Drupe"; "i" )) then "drupe" elif (. | test( "Unity M"; "i" )) then "alloy-m" elif (. | test( "Unity N"; "i" )) then "alloy-n" elif (. | test( "Unity P"; "i" )) then "alloy-p" elif (. | test( "Unity Q"; "i" )) then "alloy-q" elif (. | test( "Unit M"; "i" )) then "alloy-m" elif (. | test( "Unit N"; "i" )) then "alloy-n" elif (. | test( "Unit P"; "i" )) then "alloy-p" elif (. | test( "Unit Q"; "i" )) then "alloy-q" elif (. | test( "Apt M"; "i" )) then "alloy-m" elif (. | test( "Apt N"; "i" )) then "alloy-n" elif (. | test( "Apt P"; "i" )) then "alloy-p" elif (. | test( "Apt Q"; "i" )) then "alloy-q" elif (. | test( "Unt M"; "i" )) then "alloy-m" elif (. | test( "Unt N"; "i" )) then "alloy-n" elif (. | test( "Unt P"; "i" )) then "alloy-p" elif (. | test( "Unt Q"; "i" )) then "alloy-q" else "n/a" end; reduce .[] as $entry ([]; . + (($entry.address | neighborhood) as $district | $entry.members | map({uuid, name, phone, email, address: $entry.address, $district, members: $entry.members})))'

# cat directory.json | jq '. | reduce .[] as $entry ([]; . + (($entry.address | neighborhood) as $district | $entry.members | map({uuid, name, phone, email, address: $entry.address, $district, members: $entry.members})))' > directory-cleaned.json
# cat directory.json | jq '. | reduce .[] as $entry ([]; . + ($entry.members | map({uuid, name, phone, email, address: $entry.address, district: $entry.district})))' > directory-cleaned.json

echo "fetching elders"

curl 'https://lcr.churchofjesuschrist.org/services/orgs/sub-orgs-with-callings?lang=eng&subOrgId=5873015' -H 'pragma: no-cache' -H 'cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; cr-aths=shown; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; __VCAP_ID__=0235c398-1131-42b8-6a1c-53b1; amlbcookie=74; s_ppvl=temples.lds.org%253A%2522%2522%2C62%2C62%2C2007%2C2000%2C889%2C3840%2C2160%2C1%2CL; s_ppv=temples.lds.org%253A%2522%2522%2C100%2C62%2C1631%2C2000%2C889%2C3840%2C2160%2C1%2CL; ADRUM=s=1561173296504&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx6y9mpg&sl=1&tt=0&bcn=%2F%2F173e2514.akstat.io%2F&obo=1&ld=6tz&hd=7dy"; TS01289383=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; TS01b89640=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; lds-id=AQIC5wM2LY4SfcztT6iFA9XtmyfkPdYZ6b8zSQrjtCS6FCQ.*AAJTSQACMDIAAlNLABMxNjI0ODYxMjM3MDcyNTIzNDczAAJTMQACMDQ.*; mboxEdgeCluster=28; ObSSOCookie='"${ObSSOCookie}"'; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_122#1624420966|session#144bf5d2e7be4f06ba51e97f3cf33493#1561178026; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561780966%7C9%7CMCAAMB-1561780966%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561183366s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; s_sq=ldsall%3D%2526pid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252F%25253Flang%25253Deng%2526oid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Forgs%25252F5873015%25253Flang%25253Deng%2526ot%253DA; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:24$_ss:0$_st:1561177971061$vapi_domain:churchofjesuschrist.org$dc_visit:24$ses_id:1561175744074%3Bexp-session$_pn:2%3Bexp-session$dc_event:4%3Bexp-session$dc_region:us-east-1%3Bexp-session; t_ppv=undefined%2C82%2C69%2C460%2C10094; ADRUM_BTa=R:0|g:04eccc01-0ecf-4c00-b7c9-0edf8fea7608|n:customer1_acb14d98-cf8b-4f6d-8860-1c1af7831070; ADRUM_BT1=R:0|i:14680|e:264' -H 'accept-encoding: gzip, deflate, br' -H 'accept-language: en-US,en;q=0.9' -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'accept: application/json, text/plain, */*' -H 'cache-control: no-cache' -H 'authority: lcr.churchofjesuschrist.org' -H 'referer: https://lcr.churchofjesuschrist.org/orgs/5873015?lang=eng' --compressed > eq.json
sleep 2

cat eq.json | jq '.[0] as $head | $head.filterOffices | reduce .[] as $item ({}; . * ($item.codes | reduce .[] as $code ({}; . * ({ ($code|tostring): $item.name })))) | . as $officeMap | $head.members | map({ name, gender, birthDate, priesthood: $officeMap[(.priesthoodCode | tostring)], actualAge, nonMember, endowed, eligibleForHomeTeachingAssignment })' > eq-cleaned.json

echo "fetching ym"

curl 'https://lcr.churchofjesuschrist.org/services/orgs/sub-orgs-with-callings?lang=eng&subOrgId=209075' -H 'pragma: no-cache' -H 'cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; cr-aths=shown; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; amlbcookie=74; s_ppvl=temples.lds.org%253A%2522%2522%2C62%2C62%2C2007%2C2000%2C889%2C3840%2C2160%2C1%2CL; s_ppv=temples.lds.org%253A%2522%2522%2C100%2C62%2C1631%2C2000%2C889%2C3840%2C2160%2C1%2CL; ADRUM=s=1561173296504&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx6y9mpg&sl=1&tt=0&bcn=%2F%2F173e2514.akstat.io%2F&obo=1&ld=6tz&hd=7dy"; TS01289383=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; TS01b89640=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; lds-id=AQIC5wM2LY4SfcztT6iFA9XtmyfkPdYZ6b8zSQrjtCS6FCQ.*AAJTSQACMDIAAlNLABMxNjI0ODYxMjM3MDcyNTIzNDczAAJTMQACMDQ.*; mboxEdgeCluster=28; ObSSOCookie='"${ObSSOCookie}"'; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561781719%7C9%7CMCAAMB-1561781719%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561184119s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; __VCAP_ID__=ee441075-b341-4776-7cd4-b460; s_sq=ldsall%3D%2526pid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Fministering%25253Flang%25253Deng%252526type%25253DEQ%2526oid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Forgs%25252F209075%25253Flang%25253Deng%2526ot%253DA; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_122#1624421361|session#144bf5d2e7be4f06ba51e97f3cf33493#1561178843; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:24$_ss:0$_st:1561178782633$vapi_domain:churchofjesuschrist.org$dc_visit:24$ses_id:1561175744074%3Bexp-session$_pn:7%3Bexp-session$dc_event:12%3Bexp-session$dc_region:us-east-1%3Bexp-session; t_ppv=undefined%2C0%2C90%2C460%2C1032; ADRUM_BTa=R:0|g:4ba5f8ad-eb8b-4efb-97f2-2566c26cadd2|n:customer1_acb14d98-cf8b-4f6d-8860-1c1af7831070; ADRUM_BT1=R:0|i:14680|e:309' -H 'accept-encoding: gzip, deflate, br' -H 'accept-language: en-US,en;q=0.9' -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'accept: application/json, text/plain, */*' -H 'cache-control: no-cache' -H 'authority: lcr.churchofjesuschrist.org' -H 'referer: https://lcr.churchofjesuschrist.org/orgs/209075?lang=eng' --compressed > ym.json
sleep 2

cat ym.json | jq '.[0].children | map(select(((.filterOffices | length) > 0))) | map(. as $head | $head.filterOffices | reduce .[] as $item ({}; . * ($item.codes | reduce .[] as $code ({}; . * ({ ($code|tostring): $item.name })))) | . as $officeMap | $head.members | map({ name, gender, birthDate, priesthood: $officeMap[(.priesthoodCode | tostring)], actualAge, nonMember, endowed, eligibleForHomeTeachingAssignment })) | reduce .[] as $quorum ([]; . + $quorum) | map(select(.eligibleForHomeTeachingAssignment == true))' > ym-cleaned.json

echo "fetching ministering assignments"

# curl 'https://lcr.churchofjesuschrist.org/ministering?lang=eng&type=EQ' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3' -H 'Referer: https://lcr.churchofjesuschrist.org/ministering?lang=eng&type=EQ' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; check=true; TS01b07831=01999b702376837ed240761f4031721b2e4113ec4aac5aa7b60dbfafdaaedac12f1bd031b079925219ef7a7273106a102d02af37dc; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; audience_s_split=79; s_cc=true; ADRUM=s=1560745432298&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; TS011e50d7=01999b7023daef8de6a4625b769539a77e8ea8e9345540e5d3cc2b0bed5d9d8964e9699f56fa9f1a5b3db33e351ed885609850a548; amlbcookie=75; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jwzvj228&sl=1&tt=37u&bcn=%2F%2F17d98a5e.akstat.io%2F&ld=383&nu=d8c25fb915b8ce73b552b78eb3a473dc&cl=4vg&ul=4vr&hd=5qp"; JSESSIONID=0; cr-aths=shown; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18045%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561352158%7C9%7CMCAAMB-1561352158%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1560754558s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; TS01289383=01999b7023d9337f7bc8922bb9c7d25ebf670283dd0d5fe742bba63e33936a0a2a5b985f284f705fcd4cd4f5fae3afaecff3cfa62d; TS01b89640=01999b7023d9337f7bc8922bb9c7d25ebf670283dd0d5fe742bba63e33936a0a2a5b985f284f705fcd4cd4f5fae3afaecff3cfa62d; lds-id=AQIC5wM2LY4SfcwoCm8xaVExXthYbwNuUq2-Mn47T3Mrymc.*AAJTSQACMDIAAlNLABMxMTAzNjU5Nzc2MjI5MzgxNjkzAAJTMQACMDU.*; ObSSOCookie='"${ObSSOCookie}"'; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_87#1624017951|session#fd89cd31169d45d589cea3ba41432eb5#1560775141; __VCAP_ID__=80f5e5ec-58e7-42c3-4442-cc29; s_sq=%5B%5BB%5D%5D; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:11$_ss:0$_st:1560775081529$vapi_domain:churchofjesuschrist.org$dc_visit:11$ses_id:1560773150318%3Bexp-session$_pn:3%3Bexp-session$dc_event:6%3Bexp-session$dc_region:us-east-1%3Bexp-session; t_ppv=undefined%2C5%2C5%2C460%2C66376' --compressed | sed '/__NEXT_DATA__/!d; s/^[^=]*= //g' > ministering-eq.json
# sleep 2

curl 'https://lcr.churchofjesuschrist.org/ministering-proposed-assignments?lang=eng&type=EQ' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3' -H 'Referer: https://lcr.churchofjesuschrist.org/ministering?lang=eng&type=EQ' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; cr-aths=shown; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; amlbcookie=74; s_ppvl=temples.lds.org%253A%2522%2522%2C62%2C62%2C2007%2C2000%2C889%2C3840%2C2160%2C1%2CL; s_ppv=temples.lds.org%253A%2522%2522%2C100%2C62%2C1631%2C2000%2C889%2C3840%2C2160%2C1%2CL; ADRUM=s=1561173296504&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx6y9mpg&sl=1&tt=0&bcn=%2F%2F173e2514.akstat.io%2F&obo=1&ld=6tz&hd=7dy"; TS01289383=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; TS01b89640=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; lds-id=AQIC5wM2LY4SfcztT6iFA9XtmyfkPdYZ6b8zSQrjtCS6FCQ.*AAJTSQACMDIAAlNLABMxNjI0ODYxMjM3MDcyNTIzNDczAAJTMQACMDQ.*; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561781719%7C9%7CMCAAMB-1561781719%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561184119s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_122#1624421361|session#144bf5d2e7be4f06ba51e97f3cf33493#1561180526; __VCAP_ID__=ee441075-b341-4776-7cd4-b460; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:24$_ss:0$_st:1561180466347$vapi_domain:churchofjesuschrist.org$dc_visit:24$ses_id:1561175744074%3Bexp-session$_pn:9%3Bexp-session$dc_event:19%3Bexp-session$dc_region:us-east-1%3Bexp-session; ObSSOCookie='"${ObSSOCookie}"'; s_sq=ldsall%3D%2526pid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Fministering-proposed-assignments%25253Flang%25253Deng%252526type%25253DEQ%2526oid%253Dfunction%252528%252529%25257B%25257D%2526oidt%253D2%2526ot%253DSUBMIT; ADRUM_BTa=R:85|g:4bab58c6-84d8-4517-970e-650a456c63a4|n:customer1_acb14d98-cf8b-4f6d-8860-1c1af7831070; ADRUM_BT1=R:85|i:14680|e:162; t_ppv=undefined%2C99%2C97%2C2440%2C516670' --compressed | sed '/__NEXT_DATA__/!d; s/^[^=]*= //g' > ministering-eq.json
sleep 2


cat ministering-eq.json | jq '.props.initialState.ministeringData.elders | reduce .[] as $district ([]; . + ($district.companionships | reduce .[] as $companionship ([]; . + $companionship.ministers))) | sort_by(.name)' > ministering-brothers.json

cat ministering-eq.json | jq '.props.initialState.ministeringData.elders | reduce .[] as $district ([]; . + ($district.companionships | reduce .[] as $companionship ([]; . + $companionship.assignments))) | sort_by(.name)' > ministering-families.json
sleep 2

yarn start

echo "generating report"

cat report.json | jq '.' > report-final.json
sleep 2

echo "generating summary"

# cat report-final.json| jq '.by_district | to_entries | map({key, value: (.value | map({ name, age: .actualAge }))}) | from_entries' > report-summary.json
cat report-final.json| jq --sort-keys '{ministering_brothers: .ministering_brothers.by_district | to_entries | map({key, value: (.value | map(.name + " (" + (.actualAge | tostring) + ")") | sort)}) | from_entries, ministering_families: .ministering_families.by_district | to_entries | map({key, value: (.value | map(.name) | sort)}) | from_entries}' > report-summary.json
cat report-summary.json | jq '.'

echo "DONE!"

