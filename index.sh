lines=$(cat cookie.txt | perl -p -e 's# #\n#g' | grep 'ObSSOCookie\|directory_access_token\|directory_refresh_token')
authorization_token=$(cat cookie.txt | perl -p -e 's#^.*authorization: Bearer ([^'"'"']*).*#\1#g')
refresh_token=$(cat cookie.txt | perl -p -e 's#^.*-H '"'"'x-refresh: ([^'"'"']*).*#\1#g')
ObSSOCookie=$(echo $lines | perl -p -e 's#^.*ObSSOCookie=([^ ;]*).*#\1#g' | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
directory_access_token=$(echo $lines | perl -p -e 's#^.*directory_access_token=([^ ;]*).*#\1#g' | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
directory_refresh_token=$(echo $lines | perl -p -e 's#^.*directory_refresh_token=([^ ;]*).*#\1#g' | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')

# ObSSOCookie=$(echo $lines | grep ObSSOCookie | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
# directory_access_token=$(echo $lines | grep directory_access_token | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')
# directory_refresh_token=$(echo $lines | grep directory_refresh_token | perl -p -e 's#^[^=]*=([^;]*).*#\1#g')

# echo $lines | perl -p -e 's# #\n#g'
# echo $ObSSOCookie

echo "authorization_token=\"${authorization_token}\""
echo "refresh_token=\"${refresh_token}\""
echo "ObSSOCookie=\"${ObSSOCookie}\""
echo "directory_access_token=\"${directory_access_token}\""
echo "directory_refresh_token=\"${directory_refresh_token}\""

read cont


echo "fetching directory"

# curl 'https://directory.churchofjesuschrist.org/api/v4/households?unit=13730' -H 'Sec-Fetch-Mode: cors' -H 'Referer: https://directory.churchofjesuschrist.org/13730' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.87 Safari/537.36' -H 'x-refresh: '"${refresh_token}" -H 'Accept-Language: en' -H 'authorization: Bearer '"${authorization_token}" --compressed > directory.json

curl 'https://directory.churchofjesuschrist.org/api/v4/households?unit=13730' -H 'Pragma: no-cache' -H 'Sec-Fetch-Site: same-origin' -H 'Accept-Encoding: gzip, deflate, br' -H 'x-refresh: '"${refresh_token}" -H 'Accept-Language: en' -H 'authorization: Bearer '"${authorization_token}" -H 'Sec-Fetch-Mode: cors' -H 'Accept: */*' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.87 Safari/537.36' -H 'Cache-Control: no-cache' -H 'Referer: https://directory.churchofjesuschrist.org/13730' -H $'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; WRUIDCD=1979799963828235; lds-preferred-lang-v2=eng; __CT_Data=gpv=18&ckp=tld&dm=churchofjesuschrist.org&apv_59_www11=19&cpv_59_www11=18&rpv_59_www11=18; ctm={\'pgv\':74967302419333|\'vst\':2542134181393777|\'vstr\':5589777858429154|\'intr\':1563820041606|\'v\':1|\'lvst\':304}; s_fid=10C2A7BB8E217B78-195A92D72803F241; _gcl_au=1.1.1161084623.1564161692; _ga=GA1.2.1976242211.1564161692; check=true; TS01b07831=01999b7023c71f1fcbeee5b7e9f36b7e495ab2d50362ac5c86a92081c79bf13d24993c1ba84cba1872b2094bf981ccc985e78737cc; audience_s_split=19; s_cc=true; amlbcookie=75; TS011e50d7=01999b70239ad4936aae6a27f8fc2534ed10a9fcf756674f8faa9bd8bf281130f95734d06dc71f7f651922e434c0595ea3ec9cc549; TS01289383=01999b7023d7031d746945126d75fbff49a7f86caf2fec06593658c45137b3c7c05eb6bc7d6b75684a25a95acf5d8e555eeb1eb0a9; TS01b89640=01999b7023d7031d746945126d75fbff49a7f86caf2fec06593658c45137b3c7c05eb6bc7d6b75684a25a95acf5d8e555eeb1eb0a9; lds-id=AQIC5wM2LY4SfcyoeEs99rFEQLtwfAu3ZqjszOKZxswJsU0.*AAJTSQACMDIAAlNLABM3NTMzMzY1MTg3NzQ0MTk2NTY0AAJTMQACMDU.*; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; directory_access_token='"${directory_access_token}"'; directory_refresh_token='"${directory_refresh_token}"'; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=-330454231%7CMCIDTS%7C18127%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1566759798%7C9%7CMCAAMB-1566759798%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1566162198s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C3.1.2; mboxEdgeCluster=28; TS0186bb65=01999b70239503f9df1ebbb3ce2aadb5c0b92e85d0e6b1ac1ca716c7c86269465d084df560d46ff8a04f523a86c65823c30e243a29; ObSSOCookie='"${ObSSOCookie}"'; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_135#1629400550|session#247ef7c58e434df686291204eec534fb#1566156147; s_sq=%5B%5BB%5D%5D; t_ppv=Ward%20Directory%20and%20Map%2C0%2C100%2C447%2C3295; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:94$_ss:0$_st:1566157551162$vapi_domain:churchofjesuschrist.org$dc_visit:94$_se:14$ses_id:1566154276880%3Bexp-session$_pn:4%3Bexp-session$dc_event:13%3Bexp-session$dc_region:us-east-1%3Bexp-session' -H 'Connection: keep-alive' --compressed > directory.json
sleep 4

echo "fetching directory contact info"

cat directory.json | jq 'map(.members) | flatten | map(.name)' > directory-names.json
cat directory.json | jq 'map(. as $household | $household | {phone, email, address, district} as $hdata | $household.members | map({name, phone: (if (.phone | length) > 0 then .phone else $hdata.phone end), email: (if (.email | length) > 0 then .email else $hdata.email end), address: $hdata.address, district: $hdata.district })) | flatten' > directory-contact-info.json


# curl 'https://directory.churchofjesuschrist.org/api/v4/households?unit=13730' -H 'Pragma: no-cache' -H 'Accept-Encoding: gzip, deflate, br' -H 'x-refresh: 7ec81c2f-5f5b-42db-96e1-8eea3555c4c3' -H 'Accept-Language: en' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'Accept: */*' -H 'Cache-Control: no-cache' -H 'authorization: Bearer '"${authorization_token}" -H 'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; amlbcookie=74; ADRUM=s=1561094320300&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx5n8io4&sl=2&tt=3ws&bcn=%2F%2F17d98a5f.akstat.io%2F&ld=iio&nu=d8c25fb915b8ce73b552b78eb3a473dc&cl=jyu&ul=jz6&hd=kjp"; TS01289383=01999b7023068f27179da7e28c4900543f2fce1f371c7a7ec507d080f9faf989b1f2160ce83eceb477532db7c58ddaba84931cd79a; TS01b89640=01999b7023068f27179da7e28c4900543f2fce1f371c7a7ec507d080f9faf989b1f2160ce83eceb477532db7c58ddaba84931cd79a; lds-id=AQIC5wM2LY4SfcwNo0u0dq7NCq_AbcsbWJeudQEo6s_b3_Q.*AAJTSQACMDIAAlNLABMzNTA2MTI5OTk0MzExNDEzMTkxAAJTMQACMDQ.*; mboxEdgeCluster=28; ObSSOCookie='"${ObSSOCookie}"'; s_sq=%5B%5BB%5D%5D; TS0186bb65=01999b70232269ff637dbc011f79cd61b8dbf52d1b967ddcbfd7a1e3b97b257a454cf184a07cae282001bcfdade0854bbad865729d; directory_access_token='"${directory_access_token}"'; directory_refresh_token='"${directory_refresh_token}"'; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=-330454231%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561726626%7C9%7CMCAAMB-1561726626%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561129026s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C3.1.2; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_20#1624366628|session#ff3230f273da400499cd58b8c2185156#1561123662; t_ppv=Ward%20Directory%20and%20Map%2C0%2C100%2C460%2C4182; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:19$_ss:0$_st:1561123627260$vapi_domain:churchofjesuschrist.org$dc_visit:19$ses_id:1561119682911%3Bexp-session$_pn:6%3Bexp-session$dc_event:12%3Bexp-session$dc_region:us-east-1%3Bexp-session' -H 'Connection: keep-alive' -H 'Referer: https://directory.churchofjesuschrist.org/13730' --compressed > directory.json
sleep 2

cp directory.json directory-orig.json

cat directory-orig.json | jq 'def neighborhood: if (. | test( "Dry Creek"; "i" )) then "03-dry-creek" elif (. | test( "Quivira"; "i" )) then "03-quivira" elif (. | test( "Hackberry"; "i" )) then "02-hackberry" elif (. | test( "Samara"; "i" )) then "02-samara" elif (. | test( "Serrata"; "i" )) then "02-serrata" elif (. | test( "Silver Oak"; "i" )) then "03-silver-oak" elif (. | test( "Sterling"; "i" )) then "01-sterling-loop" elif (. | test( "Syracuse"; "i" )) then "02-syracuse" elif (. | test( "Drupe"; "i" )) then "02-drupe" elif (. | test( "Unity M"; "i" )) then "01-alloy-m" elif (. | test( "Unity N"; "i" )) then "01-alloy-n" elif (. | test( "Unity P"; "i" )) then "01-alloy-p" elif (. | test( "Unity Q"; "i" )) then "01-alloy-q" elif (. | test( "Unit M"; "i" )) then "01-alloy-m" elif (. | test( "Unit N"; "i" )) then "01-alloy-n" elif (. | test( "Unit P"; "i" )) then "01-alloy-p" elif (. | test( "Unit Q"; "i" )) then "01-alloy-q" elif (. | test( "Apt M"; "i" )) then "01-alloy-m" elif (. | test( "Apt N"; "i" )) then "01-alloy-n" elif (. | test( "Apt P"; "i" )) then "01-alloy-p" elif (. | test( "Apt Q"; "i" )) then "01-alloy-q" elif (. | test( "Unt M"; "i" )) then "01-alloy-m" elif (. | test( "Unt N"; "i" )) then "01-alloy-n" elif (. | test( "Unt P"; "i" )) then "01-alloy-p" elif (. | test( "Unt Q"; "i" )) then "01-alloy-q" else "n/a" end; map(. as $orig | (.address | neighborhood) as $district | $orig + {$district})' > directory.json

# cat directory.json | jq 'def neighborhood: if (. | test( "Dry Creek"; "i" )) then "03-dry-creek" elif (. | test( "Quivira"; "i" )) then "03-quivira" elif (. | test( "Hackberry"; "i" )) then "02-hackberry" elif (. | test( "Samara"; "i" )) then "02-samara" elif (. | test( "Serrata"; "i" )) then "02-serrata" elif (. | test( "Silver Oak"; "i" )) then "03-silver-oak" elif (. | test( "Sterling"; "i" )) then "01-sterling-loop" elif (. | test( "Syracuse"; "i" )) then "02-syracuse" elif (. | test( "Drupe"; "i" )) then "02-drupe" elif (. | test( "Unity M"; "i" )) then "01-alloy-m" elif (. | test( "Unity N"; "i" )) then "01-alloy-n" elif (. | test( "Unity P"; "i" )) then "01-alloy-p" elif (. | test( "Unity Q"; "i" )) then "01-alloy-q" elif (. | test( "Unit M"; "i" )) then "01-alloy-m" elif (. | test( "Unit N"; "i" )) then "01-alloy-n" elif (. | test( "Unit P"; "i" )) then "01-alloy-p" elif (. | test( "Unit Q"; "i" )) then "01-alloy-q" elif (. | test( "Apt M"; "i" )) then "01-alloy-m" elif (. | test( "Apt N"; "i" )) then "01-alloy-n" elif (. | test( "Apt P"; "i" )) then "01-alloy-p" elif (. | test( "Apt Q"; "i" )) then "01-alloy-q" elif (. | test( "Unt M"; "i" )) then "01-alloy-m" elif (. | test( "Unt N"; "i" )) then "01-alloy-n" elif (. | test( "Unt P"; "i" )) then "01-alloy-p" elif (. | test( "Unt Q"; "i" )) then "01-alloy-q" else "n/a" end; reduce .[] as $entry ([]; . + (($entry.address | neighborhood) as $district | $entry.members | map({uuid, name, phone, email, address: $entry.address, $district, members: $entry.members})))'

# cat directory.json | jq '. | reduce .[] as $entry ([]; . + (($entry.address | neighborhood) as $district | $entry.members | map({uuid, name, phone, email, address: $entry.address, $district, members: $entry.members})))' > directory-cleaned.json
# cat directory.json | jq '. | reduce .[] as $entry ([]; . + ($entry.members | map({uuid, name, phone, email, address: $entry.address, district: $entry.district})))' > directory-cleaned.json

echo "fetching elders"

curl 'https://lcr.churchofjesuschrist.org/services/orgs/sub-orgs-with-callings?lang=eng&subOrgId=5873015' -H 'pragma: no-cache' -H 'cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; cr-aths=shown; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; __VCAP_ID__=0235c398-1131-42b8-6a1c-53b1; amlbcookie=74; s_ppvl=temples.lds.org%253A%2522%2522%2C62%2C62%2C2007%2C2000%2C889%2C3840%2C2160%2C1%2CL; s_ppv=temples.lds.org%253A%2522%2522%2C100%2C62%2C1631%2C2000%2C889%2C3840%2C2160%2C1%2CL; ADRUM=s=1561173296504&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx6y9mpg&sl=1&tt=0&bcn=%2F%2F173e2514.akstat.io%2F&obo=1&ld=6tz&hd=7dy"; TS01289383=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; TS01b89640=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; lds-id=AQIC5wM2LY4SfcztT6iFA9XtmyfkPdYZ6b8zSQrjtCS6FCQ.*AAJTSQACMDIAAlNLABMxNjI0ODYxMjM3MDcyNTIzNDczAAJTMQACMDQ.*; mboxEdgeCluster=28; ObSSOCookie='"${ObSSOCookie}"'; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_122#1624420966|session#144bf5d2e7be4f06ba51e97f3cf33493#1561178026; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561780966%7C9%7CMCAAMB-1561780966%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561183366s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; s_sq=ldsall%3D%2526pid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252F%25253Flang%25253Deng%2526oid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Forgs%25252F5873015%25253Flang%25253Deng%2526ot%253DA; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:24$_ss:0$_st:1561177971061$vapi_domain:churchofjesuschrist.org$dc_visit:24$ses_id:1561175744074%3Bexp-session$_pn:2%3Bexp-session$dc_event:4%3Bexp-session$dc_region:us-east-1%3Bexp-session; t_ppv=undefined%2C82%2C69%2C460%2C10094; ADRUM_BTa=R:0|g:04eccc01-0ecf-4c00-b7c9-0edf8fea7608|n:customer1_acb14d98-cf8b-4f6d-8860-1c1af7831070; ADRUM_BT1=R:0|i:14680|e:264' -H 'accept-encoding: gzip, deflate, br' -H 'accept-language: en-US,en;q=0.9' -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'accept: application/json, text/plain, */*' -H 'cache-control: no-cache' -H 'authority: lcr.churchofjesuschrist.org' -H 'referer: https://lcr.churchofjesuschrist.org/orgs/5873015?lang=eng' --compressed > eq.json
sleep 2

cat eq.json | jq '.[0] as $head | $head.filterOffices | reduce .[] as $item ({}; . * ($item.codes | reduce .[] as $code ({}; . * ({ ($code|tostring): $item.name })))) | . as $officeMap | $head.members | map({ name, gender, birthDate, birthDayFormatted, priesthood: $officeMap[(.priesthoodCode | tostring)], actualAge, nonMember, endowed, eligibleForHomeTeachingAssignment })' > eq-cleaned.json

echo "fetching members with callings"

curl 'https://lcr.churchofjesuschrist.org/services/report/members-with-callings?lang=eng&unitNumber=13730' -H 'Pragma: no-cache' -H 'Sec-Fetch-Site: same-origin' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.87 Safari/537.36' -H 'Sec-Fetch-Mode: cors' -H 'Accept: application/json, text/plain, */*' -H 'Cache-Control: no-cache' -H 'Referer: https://lcr.churchofjesuschrist.org/orgs/members-with-callings?lang=eng' -H $'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; WRUIDCD=1979799963828235; lds-preferred-lang-v2=eng; cr-aths=shown; __CT_Data=gpv=18&ckp=tld&dm=churchofjesuschrist.org&apv_59_www11=19&cpv_59_www11=18&rpv_59_www11=18; ctm={\'pgv\':74967302419333|\'vst\':2542134181393777|\'vstr\':5589777858429154|\'intr\':1563820041606|\'v\':1|\'lvst\':304}; s_fid=10C2A7BB8E217B78-195A92D72803F241; _gcl_au=1.1.1161084623.1564161692; _ga=GA1.2.1976242211.1564161692; check=true; TS01b07831=01999b7023f1259cf2ce3e665baf3405fe41d3abbdb4fee0587cfb20f21f96004082272dbb85d261fbe2b39e961acf7c68f780b070; audience_s_split=61; s_cc=true; TS011e50d7=01999b7023f4a9722d5d9696c23bb88cbb92310c692edc3721a508d7b7412e55bf9f1bded1887717428ba8abb8c24f42cc266abab6; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; ADRUM=s=1565466898295&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; __VCAP_ID__=fd21059e-ff25-43e4-445b-2dc3; TS01a096ec=01999b70235e48864a88e7e2446ef0df8e1dafed0c72b4a756f890a2d3852b1d32353e1af08545c6d12ff192a4c2dafc8c3899d509; amlbcookie=76; TS01289383=01999b7023f185b5f5bc1655d91369277e8272794750e21e40f858a7c81b33c06e953233e1e907b876fd3c1b496b40ac843f05ea0b; TS01b89640=01999b7023f185b5f5bc1655d91369277e8272794750e21e40f858a7c81b33c06e953233e1e907b876fd3c1b496b40ac843f05ea0b; lds-id=AQIC5wM2LY4Sfcxvi6i9blXbjN4UtOjChDQ7XX-hlA8nZGM.*AAJTSQACMDIAAlNLABQtODEwMTkxMTY1ODg1MDM3ODY2OAACUzEAAjA2*; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=-330454231%7CMCIDTS%7C18119%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1566142218%7C9%7CMCAAMB-1566142218%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1565544618s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C3.1.2; mboxEdgeCluster=28; ObSSOCookie='"${ObSSOCookie}"'' -H 'Connection: keep-alive' --compressed > members-with-callings.json
sleep 2

jq -n 'inputs | {"object": . , "filename": input_filename, "lineNumber": input_line_number}' directory.json members-with-callings.json eq-cleaned.json | jq -ns 'inputs' | jq '. as $all | $all | map(select(.filename == "eq-cleaned.json"))[0].object | map({name, age: .actualAge, birthDay: .birthDayFormatted}) as $eqInfo | $all | map(select(.filename == "members-with-callings.json"))[0].object | map({name, position, organization, unitName}) as $mwcInfo | map(select(.gender == "MALE" and ([.organization] as $organization | ((["Young Men", "Primary", "Bishopric", "High Council"] | contains($organization)) or (.organization | contains("Stake"))) ) )) | map(.name) as $targetMembers | $all | map(select(.filename == "directory.json"))[0].object | map(. as $household | .members | map(select([.name] as $targetMember | $targetMembers | contains($targetMember)))  | map({name, district: ($household | .district), address: $household.address, email, phone, age: (.name as $mName | $eqInfo | map(select(.name == $mName))[0].age), birthDay: (.name as $mName | $eqInfo | map(select(.name == $mName))[0].birthDay), positions: (.name as $mName | $mwcInfo | map(select(.name == $mName)) | reverse | map({unitName, organization, position})) })[0]) | map(select((. == null | not) and (.age == null | not)))| sort_by(.district, .positions[0].organization, .name)' > eq-members-with-aux-positions.json

echo "fetching sisters"

curl 'https://lcr.churchofjesuschrist.org/services/orgs/sub-orgs-with-callings?lang=eng&subOrgId=209076' -H 'Pragma: no-cache' -H 'Sec-Fetch-Site: same-origin' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.87 Safari/537.36' -H 'Sec-Fetch-Mode: cors' -H 'Accept: application/json, text/plain, */*' -H 'Cache-Control: no-cache' -H 'Referer: https://lcr.churchofjesuschrist.org/orgs/209076?lang=eng&members' -H $'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; WRUIDCD=1979799963828235; lds-preferred-lang-v2=eng; cr-aths=shown; __CT_Data=gpv=18&ckp=tld&dm=churchofjesuschrist.org&apv_59_www11=19&cpv_59_www11=18&rpv_59_www11=18; ctm={\'pgv\':74967302419333|\'vst\':2542134181393777|\'vstr\':5589777858429154|\'intr\':1563820041606|\'v\':1|\'lvst\':304}; s_fid=10C2A7BB8E217B78-195A92D72803F241; _gcl_au=1.1.1161084623.1564161692; _ga=GA1.2.1976242211.1564161692; check=true; TS01b07831=01999b7023f1259cf2ce3e665baf3405fe41d3abbdb4fee0587cfb20f21f96004082272dbb85d261fbe2b39e961acf7c68f780b070; audience_s_split=61; s_cc=true; TS011e50d7=01999b7023f4a9722d5d9696c23bb88cbb92310c692edc3721a508d7b7412e55bf9f1bded1887717428ba8abb8c24f42cc266abab6; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; ADRUM=s=1565466898295&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; __VCAP_ID__=fd21059e-ff25-43e4-445b-2dc3; TS01a096ec=01999b70235e48864a88e7e2446ef0df8e1dafed0c72b4a756f890a2d3852b1d32353e1af08545c6d12ff192a4c2dafc8c3899d509; amlbcookie=76; TS01289383=01999b702330063d7498a4770a2c874b1493b684f17ccb535f231cbdbc88e5fc516de44253ea5743305bbca63d1528661de2ef1e8f; TS01b89640=01999b702330063d7498a4770a2c874b1493b684f17ccb535f231cbdbc88e5fc516de44253ea5743305bbca63d1528661de2ef1e8f; lds-id=AQIC5wM2LY4SfcwpK0RG27mpz4sEEOSBKduNvcI913Sct1I.*AAJTSQACMDIAAlNLABQtODU4MjM4Mzk4NzY5MzU3MTc3MAACUzEAAjA2*; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=-330454231%7CMCIDTS%7C18119%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1566138198%7C9%7CMCAAMB-1566138198%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1565540598s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C3.1.2; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_6#1628778200|session#542b53152f794a91be42f7575b0c8cf3#1565535158; mboxEdgeCluster=28; s_sq=%5B%5BB%5D%5D; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:83$_ss:0$_st:1565535199771$vapi_domain:churchofjesuschrist.org$dc_visit:83$_se:14$ses_id:1565533297617%3Bexp-session$_pn:2%3Bexp-session$dc_event:5%3Bexp-session$dc_region:us-east-1%3Bexp-session; ObSSOCookie='"${ObSSOCookie}"'; t_ppv=undefined%2C82%2C48%2C369%2C710224; ADRUM_BTa=R:0|g:51d775cf-9216-445f-a6c1-854b347a02af|n:customer1_acb14d98-cf8b-4f6d-8860-1c1af7831070; ADRUM_BT1=R:0|i:14680|e:361' -H 'Connection: keep-alive' --compressed > rs.json
sleep 2

# filter directory for households that only have one .head == true (this may include brothers, but they will be filtered out later on) > $singleMembers
# pull all sisters from RS and inner join with $singleMembers
# lookup callings for $targetMember

jq -n 'inputs | {"object": . , "filename": input_filename, "lineNumber": input_line_number}' directory.json members-with-callings.json rs.json | jq -ns 'inputs' | jq '. as $all | $all | map(select(.filename == "directory.json"))[0].object | map(. as $household | $household | .members | map(select(.head == true)) as $heads | $household | select(($heads | length) == 1) ) as $directory | $directory | map(.members | map(select(.head == true))[0] | .name) as $singleMembers | $all | map(select(.filename == "members-with-callings.json"))[0].object | map({name, position, organization, unitName}) as $mwcInfo| $all | map(select(.filename == "rs.json"))[0].object[0].members | map(select([.name] as $targetMember | $singleMembers | contains($targetMember))) | map({name, district: (.name as $mName | $directory | map(select(.name == $mName))[0] | .district ), age, address, phone, email, birthDayFormatted, positions: (.name as $mName | $mwcInfo | map(select(.name == $mName)) | reverse | map({unitName, organization, position}))})' > single-sisters.json

# incomplete; jq -n 'inputs | {"object": . , "filename": input_filename, "lineNumber": input_line_number}' directory.json rs.json | jq -ns 'inputs' | jq '. as $all | $all | map(select(.filename == "directory.json"))[0].object | map(select((.members | length) == 1)) | map(.name) as $singleMembers | $all | map(select(.filename == "rs.json"))[0].object[0].members | map(select([.name] as $targetMember | $singleMembers | contains($targetMember))) | map({name, age, address, phone, email, birthDayFormatted})' > single-sisters.json

echo "fetching ym"

curl 'https://lcr.churchofjesuschrist.org/services/orgs/sub-orgs-with-callings?lang=eng&subOrgId=209075' -H 'pragma: no-cache' -H 'cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; cr-aths=shown; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; amlbcookie=74; s_ppvl=temples.lds.org%253A%2522%2522%2C62%2C62%2C2007%2C2000%2C889%2C3840%2C2160%2C1%2CL; s_ppv=temples.lds.org%253A%2522%2522%2C100%2C62%2C1631%2C2000%2C889%2C3840%2C2160%2C1%2CL; ADRUM=s=1561173296504&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx6y9mpg&sl=1&tt=0&bcn=%2F%2F173e2514.akstat.io%2F&obo=1&ld=6tz&hd=7dy"; TS01289383=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; TS01b89640=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; lds-id=AQIC5wM2LY4SfcztT6iFA9XtmyfkPdYZ6b8zSQrjtCS6FCQ.*AAJTSQACMDIAAlNLABMxNjI0ODYxMjM3MDcyNTIzNDczAAJTMQACMDQ.*; mboxEdgeCluster=28; ObSSOCookie='"${ObSSOCookie}"'; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561781719%7C9%7CMCAAMB-1561781719%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561184119s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; __VCAP_ID__=ee441075-b341-4776-7cd4-b460; s_sq=ldsall%3D%2526pid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Fministering%25253Flang%25253Deng%252526type%25253DEQ%2526oid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Forgs%25252F209075%25253Flang%25253Deng%2526ot%253DA; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_122#1624421361|session#144bf5d2e7be4f06ba51e97f3cf33493#1561178843; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:24$_ss:0$_st:1561178782633$vapi_domain:churchofjesuschrist.org$dc_visit:24$ses_id:1561175744074%3Bexp-session$_pn:7%3Bexp-session$dc_event:12%3Bexp-session$dc_region:us-east-1%3Bexp-session; t_ppv=undefined%2C0%2C90%2C460%2C1032; ADRUM_BTa=R:0|g:4ba5f8ad-eb8b-4efb-97f2-2566c26cadd2|n:customer1_acb14d98-cf8b-4f6d-8860-1c1af7831070; ADRUM_BT1=R:0|i:14680|e:309' -H 'accept-encoding: gzip, deflate, br' -H 'accept-language: en-US,en;q=0.9' -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'accept: application/json, text/plain, */*' -H 'cache-control: no-cache' -H 'authority: lcr.churchofjesuschrist.org' -H 'referer: https://lcr.churchofjesuschrist.org/orgs/209075?lang=eng' --compressed > ym.json
sleep 2

cat ym.json | jq '.[0].children | map(select(((.filterOffices | length) > 0))) | map(. as $head | $head.filterOffices | reduce .[] as $item ({}; . * ($item.codes | reduce .[] as $code ({}; . * ({ ($code|tostring): $item.name })))) | . as $officeMap | $head.members | map({ name, gender, birthDate, priesthood: $officeMap[(.priesthoodCode | tostring)], actualAge, nonMember, endowed, eligibleForHomeTeachingAssignment })) | reduce .[] as $quorum ([]; . + $quorum) | map(select(.eligibleForHomeTeachingAssignment == true))' > ym-cleaned.json

echo "fetching ministering assignments"

curl 'https://lcr.churchofjesuschrist.org/ministering?lang=eng&type=EQ' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3' -H 'Referer: https://lcr.churchofjesuschrist.org/ministering?lang=eng&type=EQ' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; check=true; TS01b07831=01999b702376837ed240761f4031721b2e4113ec4aac5aa7b60dbfafdaaedac12f1bd031b079925219ef7a7273106a102d02af37dc; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; audience_s_split=79; s_cc=true; ADRUM=s=1560745432298&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; TS011e50d7=01999b7023daef8de6a4625b769539a77e8ea8e9345540e5d3cc2b0bed5d9d8964e9699f56fa9f1a5b3db33e351ed885609850a548; amlbcookie=75; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jwzvj228&sl=1&tt=37u&bcn=%2F%2F17d98a5e.akstat.io%2F&ld=383&nu=d8c25fb915b8ce73b552b78eb3a473dc&cl=4vg&ul=4vr&hd=5qp"; JSESSIONID=0; cr-aths=shown; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18045%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561352158%7C9%7CMCAAMB-1561352158%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1560754558s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; TS01289383=01999b7023d9337f7bc8922bb9c7d25ebf670283dd0d5fe742bba63e33936a0a2a5b985f284f705fcd4cd4f5fae3afaecff3cfa62d; TS01b89640=01999b7023d9337f7bc8922bb9c7d25ebf670283dd0d5fe742bba63e33936a0a2a5b985f284f705fcd4cd4f5fae3afaecff3cfa62d; lds-id=AQIC5wM2LY4SfcwoCm8xaVExXthYbwNuUq2-Mn47T3Mrymc.*AAJTSQACMDIAAlNLABMxMTAzNjU5Nzc2MjI5MzgxNjkzAAJTMQACMDU.*; ObSSOCookie='"${ObSSOCookie}"'; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_87#1624017951|session#fd89cd31169d45d589cea3ba41432eb5#1560775141; __VCAP_ID__=80f5e5ec-58e7-42c3-4442-cc29; s_sq=%5B%5BB%5D%5D; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:11$_ss:0$_st:1560775081529$vapi_domain:churchofjesuschrist.org$dc_visit:11$ses_id:1560773150318%3Bexp-session$_pn:3%3Bexp-session$dc_event:6%3Bexp-session$dc_region:us-east-1%3Bexp-session; t_ppv=undefined%2C5%2C5%2C460%2C66376' --compressed | perl -p -e 's#<#\n<#g' | sed '/__NEXT_DATA__/!d; s/<[^>]*>//g' > ministering-eq.json
# | perl -p -e 's#<#\n<#g' | sed '/__NEXT_DATA__/!d; s/^[^=]*= //g' > ministering-eq.json
# sleep 2

# curl 'https://lcr.churchofjesuschrist.org/ministering-proposed-assignments?lang=eng&type=EQ' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3' -H 'Referer: https://lcr.churchofjesuschrist.org/ministering?lang=eng&type=EQ' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'Cookie: audience_split=21; _fbp=fb.1.1558727984750.576138409; aam_sc=aamsc%3D708195; aam_uuid=45765730328637803531337720452321221401; cr-aths=shown; check=true; TS01b07831=01999b7023656e0690610759d69b74f2772803b10d626748b9f77afac2bf66e605d92dad09cea7dcc4f96f406d555d4eabe3e47d5e; audience_s_split=64; s_cc=true; TS011e50d7=01999b7023432c8754d74a1e0b12cf82596e1172e0a50f089b032af2a46842dea094c7a6999ef8c45c7f448c600167c141508af1f8; JSESSIONID=0; AMCVS_66C5485451E56AAE0A490D45%40AdobeOrg=1; TS01a096ec=01999b7023c3e74d2ba9385af2aff6ba02d6ac805ca9379f754d243143f3839b85d586478425947d7c2cefe1a9a6efb27c31542aa7; amlbcookie=74; s_ppvl=temples.lds.org%253A%2522%2522%2C62%2C62%2C2007%2C2000%2C889%2C3840%2C2160%2C1%2CL; s_ppv=temples.lds.org%253A%2522%2522%2C100%2C62%2C1631%2C2000%2C889%2C3840%2C2160%2C1%2CL; ADRUM=s=1561173296504&r=https%3A%2F%2Fwww.churchofjesuschrist.org%2F%3F479231918; RT="z=1&dm=churchofjesuschrist.org&si=c77f4221-82a5-44e7-8cfb-6c4ddad1ae73&ss=jx6y9mpg&sl=1&tt=0&bcn=%2F%2F173e2514.akstat.io%2F&obo=1&ld=6tz&hd=7dy"; TS01289383=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; TS01b89640=01999b7023decd5195e8ed03a8f5ef4f64870ec64f99f70f19020969424becee4cc528ad9b40931e9987448960a4ff064a48393f9e; lds-id=AQIC5wM2LY4SfcztT6iFA9XtmyfkPdYZ6b8zSQrjtCS6FCQ.*AAJTSQACMDIAAlNLABMxNjI0ODYxMjM3MDcyNTIzNDczAAJTMQACMDQ.*; AMCV_66C5485451E56AAE0A490D45%40AdobeOrg=1099438348%7CMCIDTS%7C18068%7CMCMID%7C45993473060174549671353300097144335983%7CMCAAMLH-1561781719%7C9%7CMCAAMB-1561781719%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1561184119s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C2.1.0; mbox=PC#ff77b07984e6447e8ca81967c1376f11.28_122#1624421361|session#144bf5d2e7be4f06ba51e97f3cf33493#1561180526; __VCAP_ID__=ee441075-b341-4776-7cd4-b460; utag_main=v_id:016aeb6d84c7000c9febf6d43f4003079007407101788$_sn:24$_ss:0$_st:1561180466347$vapi_domain:churchofjesuschrist.org$dc_visit:24$ses_id:1561175744074%3Bexp-session$_pn:9%3Bexp-session$dc_event:19%3Bexp-session$dc_region:us-east-1%3Bexp-session; ObSSOCookie='"${ObSSOCookie}"'; s_sq=ldsall%3D%2526pid%253Dhttps%25253A%25252F%25252Flcr.churchofjesuschrist.org%25252Fministering-proposed-assignments%25253Flang%25253Deng%252526type%25253DEQ%2526oid%253Dfunction%252528%252529%25257B%25257D%2526oidt%253D2%2526ot%253DSUBMIT; ADRUM_BTa=R:85|g:4bab58c6-84d8-4517-970e-650a456c63a4|n:customer1_acb14d98-cf8b-4f6d-8860-1c1af7831070; ADRUM_BT1=R:85|i:14680|e:162; t_ppv=undefined%2C99%2C97%2C2440%2C516670' --compressed | perl -p -e 's#<#\n<#g' | sed '/__NEXT_DATA__/!d; s/<[^>]*>//g' > ministering-eq.json
# | perl -p -e 's#<#\n<#g' | sed '/__NEXT_DATA__/!d' | perl -p -e 's#^.*<script id="__NEXT_DATA__" [^>]+>([^<]+).*$#$1#g' > ministering-eq.json

sleep 2

cat ministering-eq.json | jq '.props.pageProps.initialState.ministeringData.elders | reduce .[] as $district ([]; . + ($district.companionships | reduce .[] as $companionship ([]; . + $companionship.ministers))) | sort_by(.name)' > ministering-brothers.json

cat ministering-eq.json | jq '.props.pageProps.initialState.ministeringData.elders | reduce .[] as $district ([]; . + ($district.companionships | reduce .[] as $companionship ([]; . + $companionship.assignments))) | sort_by(.name)' > ministering-families.json
sleep 2

yarn start

echo "generating report"

cat report.json | jq '.' > report-final.json
sleep 2

echo "generating summary"

# cat report-final.json| jq '.by_district | to_entries | map({key, value: (.value | map({ name, age: .actualAge }))}) | from_entries' > report-summary.json
cat report-final.json| jq --sort-keys '{ministering_brothers: .ministering_brothers.by_district | to_entries | map({key, value: (.value | map(.name + " (" + (.actualAge | tostring) + ")") | sort)}) | from_entries, ministering_families: .ministering_families.by_district | to_entries | map({key, value: (.value | map(.name) | sort)}) | from_entries}' > report-summary.json
cat report-summary.json | jq '.'

echo "DONE!"

